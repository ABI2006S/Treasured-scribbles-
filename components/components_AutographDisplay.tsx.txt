'use client'

import { useInfiniteQuery } from '@tanstack/react-query'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Skeleton } from '@/components/ui/skeleton'

interface Autograph {
  id: string
  name: string
  message: string
  signature: string
  createdAt: string
}

const fetchAutographs = async ({ pageParam = 0 }) => {
  const res = await fetch(`/api/autographs?page=${pageParam}`)
  return res.json()
}

export default function AutographDisplay() {
  const {
    data,
    fetchNextPage,
    hasNextPage,
    isFetchingNextPage,
    status,
  } = useInfiniteQuery({
    queryKey: ['autographs'],
    queryFn: fetchAutographs,
    getNextPageParam: (lastPage) => lastPage.nextCursor,
  })

  if (status === 'loading') return <Skeleton className="w-full h-96" />
  if (status === 'error') return <div>Error fetching autographs</div>

  return (
    <div className="space-y-4">
      {data?.pages.map((page, i) => (
        <div key={i} className="space-y-4">
          {page.autographs.map((autograph: Autograph) => (
            <Card key={autograph.id}>
              <CardHeader>
                <CardTitle>{autograph.name}</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="mb-4">{autograph.message}</p>
                <img
                  src={autograph.signature}
                  alt={`${autograph.name}'s signature`}
                  className="max-w-full h-auto"
                />
                <p className="text-sm text-muted-foreground mt-2">
                  Signed on: {new Date(autograph.createdAt).toLocaleDateString()}
                </p>
              </CardContent>
            </Card>
          ))}
        </div>
      ))}
      {hasNextPage && (
        <Button
          onClick={() => fetchNextPage()}
          disabled={isFetchingNextPage}
          className="w-full"
        >
          {isFetchingNextPage ? 'Loading more...' : 'Load More'}
        </Button>
      )}
    </div>
  )
}